<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniFun Clock — Ultimate</title>
<style>
/* =========================
   VARIABLES & BASE STYLES
   Default theme: softer iOS-style
   ========================= */
:root{
  --accent: #4c9aff;     /* primary accent */
  --soft:   #dfeeff;     /* soft gradient */
  --bg:     linear-gradient(135deg,var(--accent),var(--soft));
  --ui-bg:  rgba(255,255,255,0.06);
  --glass:  rgba(255,255,255,0.08);
  --text:   #0b1220;
  --muted:  rgba(11,18,32,0.6);
  --clock-size: 6rem;
  --trans: 300ms;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; -webkit-font-smoothing:antialiased}
body{
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
  transition:background var(--trans), color var(--trans);
  color:var(--text);
  overflow:hidden;
  -webkit-user-select:none;user-select:none;
}

/* Wrap / card */
#wrap{
  position:relative;
  width:min(880px,94vw);
  border-radius:18px;
  padding:22px;
  display:flex;
  gap:16px;
  align-items:flex-start;
  justify-content:space-between;
  background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.5));
  box-shadow: 0 12px 40px rgba(10,20,40,0.12);
  backdrop-filter: blur(10px) saturate(1.05);
}

/* left - clock area */
#left{flex:1;min-width:240px;display:flex;flex-direction:column;gap:12px;align-items:center}
#clock{
  width:100%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;
  font-size:var(--clock-size);
  padding:18px 24px;border-radius:12px;
  background:rgba(255,255,255,0.9);
  color:var(--text);
  box-shadow: 0 8px 30px rgba(9,20,40,0.06), inset 0 -2px 8px rgba(255,255,255,0.6);
  transition:transform 400ms cubic-bezier(.2,.9,.3,1), box-shadow var(--trans), color var(--trans);
  text-align:center;
  position:relative;
}

/* right - controls */
#right{width:360px;display:flex;flex-direction:column;gap:12px;align-items:stretch}
.panel{
  border-radius:12px;padding:12px;background:rgba(255,255,255,0.85);border:1px solid var(--glass);
  box-shadow:0 6px 20px rgba(8,18,30,0.04);
  max-height:68vh;overflow:auto;
}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:6px 8px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
.tab.active{background:rgba(10,20,40,0.04);color:var(--text);border-color:rgba(10,20,40,0.03)}

/* Sections */
.section{display:none}.section.active{display:block}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed rgba(10,20,40,0.03)}
.row:last-child{border-bottom:none}
label{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}

/* Inputs */
input[type="text"], input[type="number"], select{
  width:100%;padding:8px;border-radius:8px;border:1px solid rgba(10,20,40,0.04);background:transparent;color:var(--text)
}
input[type="range"]{width:140px}
button{padding:8px 10px;border-radius:8px;border:1px solid rgba(10,20,40,0.05);background:transparent;cursor:pointer}
.smallBtn{padding:6px 8px;font-size:13px}

/* theme grid */
.themeGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.themeTile{padding:8px;border-radius:8px;border:1px solid rgba(10,20,40,0.03);text-align:center;cursor:pointer}
.accentPreview{height:20px;border-radius:6px;margin-bottom:6px}

/* particle canvas */
#particleCanvas{position:fixed;inset:0;pointer-events:none;z-index:0}

/* style variants toggle row */
.styleModes{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.modeBtn{padding:6px;border-radius:8px;border:1px solid rgba(10,20,40,0.03);cursor:pointer;background:transparent}
.modeBtn.active{background:linear-gradient(90deg, rgba(10,20,40,0.04), rgba(10,20,40,0.02));}

/* stopwatch/timer displays */
#extraTools{display:flex;gap:8px;flex-direction:column;margin-top:8px}
.timerDisplay, .swDisplay{font-weight:700;font-size:1.25rem;background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;text-align:center}

/* small helpers */
.footerSmall{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
.hidden{display:none}

/* system variants (neon, material, windows, original) */
body.style-neon { --accent: #ff4d4d; --soft:#ffccff; background: linear-gradient(135deg,#ff4d4d,#ffccff);}
body.style-material { --accent:#00bfa5; --soft:#b2f5ea; background: linear-gradient(135deg,var(--accent),var(--soft)); --text:#032; }
body.style-windows { --accent:#6b8cff; --soft:#dfe8ff; background: linear-gradient(135deg,var(--accent),var(--soft)); box-shadow: none; }
body.style-original { --accent:#ff4d4d; --soft:#ff9999; background: linear-gradient(135deg,var(--accent),var(--soft));}

/* animated gradient */
.animated-gradient { animation:gradShift 12s ease infinite; background-size:400% 400%;}
@keyframes gradShift {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* compact responsive */
@media (max-width:900px){
  #wrap{flex-direction:column;width:94vw}
  #right{width:100%}
  :root{--clock-size:4.5rem}
}
</style>
</head>
<body>
<canvas id="particleCanvas" aria-hidden="true"></canvas>

<div id="wrap" role="application" aria-label="MiniFun Clock">
  <div id="left">
    <div id="clock" role="timer" aria-live="polite">00:00:00</div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="togglePanel" class="smallBtn">Open Settings</button>
      <button id="quickSW" class="smallBtn">Stopwatch</button>
      <button id="quickTM" class="smallBtn">Timer</button>
    </div>

    <div class="footerSmall">Tip: press <kbd>Space</kbd> to start/stop stopwatch, <kbd>T</kbd> to toggle particles</div>
  </div>

  <div id="right">
    <div class="panel" id="panel" aria-hidden="true">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="general" role="tab">General</div>
        <div class="tab" data-tab="themes" role="tab">Themes</div>
        <div class="tab" data-tab="visuals" role="tab">Visuals</div>
        <div class="tab" data-tab="tools" role="tab">Tools</div>
      </div>

      <div id="general" class="section active" role="tabpanel">
        <div class="row">
          <label><input type="checkbox" id="pulse" checked> Clock Pulse</label>
          <div class="small">Pulses every 2.5s</div>
        </div>

        <div class="row">
          <label><input type="checkbox" id="rainbow"> Rainbow Text</label>
          <div class="small">Changes clock color slowly</div>
        </div>

        <div class="row">
          <label><input type="checkbox" id="cycle"> Auto Theme Cycle</label>
          <div class="small">Cycles themes every 15s</div>
        </div>

        <div class="row">
          <div class="small">Clock size</div>
          <input id="size" type="range" min="3" max="12" step="0.5" value="6">
        </div>

        <div class="row">
          <div class="small">12 / 24 hour</div>
          <label><input type="checkbox" id="h24"> 24h</label>
        </div>

        <div class="row">
          <div class="small">Wallpaper URL</div>
          <input id="wall" type="text" placeholder="https://...">
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyWall" class="smallBtn">Apply Wallpaper</button>
          <button id="clearWall" class="smallBtn">Clear Wallpaper</button>
        </div>

      </div><!-- general -->

      <div id="themes" class="section" role="tabpanel">
        <div class="small">Click tile to apply. Import/export themes below.</div>
        <div class="themeGrid" id="themeGrid" aria-live="polite"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportThemes" class="smallBtn">Export Themes</button>
          <input id="importFile" type="file" accept=".json" />
          <button id="downloadTemplate" class="smallBtn">Download Template</button>
        </div>
        <div id="themeMsg" class="small" style="margin-top:8px"></div>
      </div><!-- themes -->

      <div id="visuals" class="section" role="tabpanel">
        <div class="row">
          <label><input type="checkbox" id="particles"> Particles</label>
          <div class="small">Toggle particle engine</div>
        </div>

        <div class="row">
          <label><input type="checkbox" id="fpsOn"> FPS limiter</label>
          <div class="small">Use target FPS below</div>
        </div>

        <div class="row">
          <div class="small">Target FPS</div>
          <input id="fpsVal" type="number" min="10" max="240" value="60" style="width:92px">
        </div>

        <div class="row">
          <label><input type="checkbox" id="trails"> Glow trails</label>
          <div class="small">Makes particles leave trails</div>
        </div>

        <div class="row">
          <label><input type="checkbox" id="bgBlur"> Background Blur</label>
          <div class="small">Increase card blur</div>
        </div>

        <div class="row">
          <label><input type="checkbox" id="neon"> Neon Mode</label>
          <div class="small">Switch to neon palette</div>
        </div>

        <div class="small" style="margin-top:8px">UI Style modes:</div>
        <div class="styleModes" style="margin-top:8px">
          <button class="modeBtn active" data-mode="ios">iOS (default)</button>
          <button class="modeBtn" data-mode="neon">Neon</button>
          <button class="modeBtn" data-mode="material">Material</button>
          <button class="modeBtn" data-mode="windows">Windows</button>
          <button class="modeBtn" data-mode="original">Original</button>
        </div>

      </div><!-- visuals -->

      <div id="tools" class="section" role="tabpanel">
        <div class="small">Validator + quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="validateThemes" class="smallBtn">Validate Themes</button>
          <button id="resetThemes" class="smallBtn">Reset Themes</button>
          <button id="clearStorage" class="smallBtn">Clear Settings</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Stopwatch</div>
          <div class="swDisplay" id="swDisplay">00:00.00</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="swStart" class="smallBtn">Start</button>
            <button id="swStop" class="smallBtn">Stop</button>
            <button id="swReset" class="smallBtn">Reset</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Timer</div>
          <div class="timerDisplay" id="tDisplay">00:00:00</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="tInput" type="text" placeholder="mm:ss or hh:mm:ss">
            <button id="tStart" class="smallBtn">Start</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="tPause" class="smallBtn">Pause</button>
            <button id="tReset" class="smallBtn">Reset</button>
          </div>
        </div>

      </div><!-- tools -->
    </div><!-- panel -->
  </div><!-- right -->
</div><!-- wrap -->

<script>
/* =========================
   MiniFun Ultimate — JS
   One-file single-app
   ========================= */

/* ---- DOM helpers ---- */
const $ = (s, root=document) => root.querySelector(s);
const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

/* ---- Cached nodes ---- */
const clock = $('#clock');
const canvas = $('#particleCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
const panel = $('#panel');
const tabs = $$('.tab');
const sections = { general:$('#general'), themes:$('#themes'), visuals:$('#visuals'), tools:$('#tools') };

/* ---- UI controls ---- */
const UI = {
  pulse: $('#pulse'),
  rainbow: $('#rainbow'),
  cycle: $('#cycle'),
  size: $('#size'),
  h24: $('#h24'),
  wall: $('#wall'),
  applyWall: $('#applyWall'),
  clearWall: $('#clearWall'),
  particles: $('#particles'),
  fpsOn: $('#fpsOn'),
  fpsVal: $('#fpsVal'),
  trails: $('#trails'),
  bgBlur: $('#bgBlur'),
  neon: $('#neon'),
  fpsToggleBtn: $('#fpsOn'),
  exportThemes: $('#exportThemes'),
  importFile: $('#importFile'),
  downloadTemplate: $('#downloadTemplate'),
  validateThemes: $('#validateThemes'),
  resetThemes: $('#resetThemes'),
  clearStorage: $('#clearStorage'),
  themeGrid: $('#themeGrid'),
  themeMsg: $('#themeMsg'),
  modeBtns: $$('.modeBtn'),

  // stopwatch
  swDisplay: $('#swDisplay'), swStart: $('#swStart'), swStop: $('#swStop'), swReset: $('#swReset'),
  // timer
  tDisplay: $('#tDisplay'), tInput: $('#tInput'), tStart: $('#tStart'), tPause: $('#tPause'), tReset: $('#tReset')
};

/* ---- App state & defaults ---- */
const DEFAULTS = {
  themes: {
    red: ['#ff4d4d','#ffb3b3'],
    blue: ['#4c9aff','#dfeeff'],
    green: ['#4CAF50','#c8f6d1'],
    purple: ['#9c27b0','#e9d8f5'],
    pastel: ['#ffd1dc','#fff0f5'],
    cyber: ['#00ffd5','#004d7a']
  },
  settings: {
    pulse: true, rainbow: false, cycle: false, size: 6, h24: false,
    wall: '', particles: false, fpsOn: true, fpsVal: 60, trails: false, bgBlur: false, neon: false,
    uiMode: 'ios'
  }
};

let themes = {}; // will load from storage or defaults
let settings = {}; // runtime settings

/* ---- localStorage helpers ---- */
const STORAGE_KEY = 'minifun_ultimate_v1';
function saveAll(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({themes, settings})); }catch(e){} }
function loadAll(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) { themes = structuredClone(DEFAULTS.themes); settings = structuredClone(DEFAULTS.settings); saveAll(); return; }
    const parsed = JSON.parse(raw);
    themes = parsed.themes || structuredClone(DEFAULTS.themes);
    settings = Object.assign(structuredClone(DEFAULTS.settings), parsed.settings || {});
  }catch(e){
    themes = structuredClone(DEFAULTS.themes); settings = structuredClone(DEFAULTS.settings); saveAll();
  }
}
loadAll();

/* ---- sync UI from settings ---- */
function uiSyncFromSettings(){
  UI.pulse.checked = !!settings.pulse;
  UI.rainbow.checked = !!settings.rainbow;
  UI.cycle.checked = !!settings.cycle;
  UI.size.value = settings.size;
  UI.h24.checked = !!settings.h24;
  UI.wall.value = settings.wall || '';
  UI.particles.checked = !!settings.particles;
  UI.fpsOn.checked = !!settings.fpsOn;
  UI.fpsVal.value = settings.fpsVal || 60;
  UI.trails.checked = !!settings.trails;
  UI.bgBlur.checked = !!settings.bgBlur;
  UI.neon.checked = !!settings.neon;
  // UI mode buttons
  UI.modeBtns.forEach(b=> b.classList.toggle('active', b.dataset.mode === (settings.uiMode || 'ios')));
}
uiSyncFromSettings();

/* ---- apply UI mode styling ---- */
function applyUIMode(mode){
  document.body.classList.remove('style-neon','style-material','style-windows','style-original');
  if(mode === 'neon'){ document.body.classList.add('style-neon'); }
  if(mode === 'material'){ document.body.classList.add('style-material'); }
  if(mode === 'windows'){ document.body.classList.add('style-windows'); }
  if(mode === 'original'){ document.body.classList.add('style-original'); }
  settings.uiMode = mode;
  uiSyncFromSettings();
  saveAll();
}

/* bind mode buttons */
UI.modeBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    UI.modeBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    applyUIMode(btn.dataset.mode);
  });
});
applyUIMode(settings.uiMode || 'ios');

/* ---- theme application ---- */
let currentTheme = Object.keys(themes)[0] || 'red';
function applyTheme(name){
  if(!themes[name]) name = Object.keys(themes)[0];
  currentTheme = name;
  const [strong, soft] = themes[name];
  document.documentElement.style.setProperty('--accent', strong);
  document.documentElement.style.setProperty('--soft', soft);
  document.body.style.background = `linear-gradient(135deg, ${strong}, ${soft})`;
  // if wallpaper present, keep wallpaper on top
  if(settings.wall) {
    document.body.style.background = `url(${settings.wall}) center/cover fixed, linear-gradient(135deg, ${strong}, ${soft})`;
  }
  // apply neon toggle
  if(UI.neon.checked){ document.body.classList.add('style-neon') } else { document.body.classList.remove('style-neon') }
  // clock glow color
  clock.style.boxShadow = `0 8px 30px rgba(0,0,0,0.06), inset 0 0 40px ${strong}`;
  clock.style.color = settings.rainbow ? '' : 'inherit';
}
applyTheme(currentTheme);

/* ---- build theme grid UI ---- */
function buildThemeGrid(){
  UI.themeGrid.innerHTML = '';
  Object.keys(themes).forEach(key=>{
    const [strong, soft] = themes[key];
    const tile = document.createElement('div');
    tile.className = 'themeTile';
    tile.dataset.theme = key;
    tile.innerHTML = `<div class="accentPreview" style="background:linear-gradient(90deg, ${strong}, ${soft})"></div><div style="font-size:13px">${key}</div>`;
    tile.addEventListener('click', ()=>{ applyTheme(key); saveAll(); UI.themeMsg.textContent = `Applied ${key}`; setTimeout(()=>UI.themeMsg.textContent='',1200) });
    UI.themeGrid.appendChild(tile);
  });
}
buildThemeGrid();

/* ---- Tab handling ---- */
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    $$('.section').forEach(s=>s.classList.remove('active'));
    const id = t.dataset.tab;
    $(`#${id}`).classList.add('active');
  });
});

/* ---- Toggle panel button ---- */
$('#togglePanel').addEventListener('click', ()=>{
  const visible = panel.getAttribute('aria-hidden') === 'false';
  panel.style.display = visible ? 'none' : 'block';
  panel.setAttribute('aria-hidden', visible ? 'true' : 'false');
});

/* ---- Clock logic (12/24 + size + pulse + rainbow) ---- */
let clockTimer = null;
function updateClock(){
  const d = new Date();
  let h = d.getHours();
  const m = d.getMinutes(), s = d.getSeconds();
  if(!UI.h24.checked){
    h = h % 12 || 12;
  }
  const hh = String(h).padStart(2,'0');
  const mm = String(m).padStart(2,'0');
  const ss = String(s).padStart(2,'0');
  clock.textContent = `${hh}:${mm}:${ss}`;
}
function startClock(){ if(clockTimer) clearInterval(clockTimer); updateClock(); clockTimer = setInterval(updateClock, 1000); }
startClock();

/* Pulse */
let pulseInterval = null;
function startPulse(){ if(pulseInterval) return; pulseInterval = setInterval(()=>{ clock.style.transform='scale(1.06)'; setTimeout(()=>clock.style.transform='scale(1)',500); },2500); }
function stopPulse(){ clearInterval(pulseInterval); pulseInterval=null; clock.style.transform='scale(1)'; }
if(UI.pulse.checked) startPulse();

/* Rainbow */
let hue = 0, rainbowRAF = null;
function rainbowLoop(){
  if(!UI.rainbow.checked){ if(rainbowRAF) cancelAnimationFrame(rainbowRAF); rainbowRAF = null; applyTheme(currentTheme); return; }
  hue = (hue + 0.6) % 360;
  clock.style.color = `hsl(${hue},100%,45%)`;
  rainbowRAF = requestAnimationFrame(rainbowLoop);
}

/* Theme cycle */
let cycleTimer = null;
function startCycle(){ if(cycleTimer) return; cycleTimer = setInterval(()=>{ if(!UI.cycle.checked) return; const keys = Object.keys(themes); const idx = (keys.indexOf(currentTheme)+1) % keys.length; applyTheme(keys[idx]); }, 15000); }
function stopCycle(){ clearInterval(cycleTimer); cycleTimer=null; }
if(UI.cycle.checked) startCycle();

/* ---- Wire UI controls to settings and save sync ---- */
function applyAllSettingsToUI(){
  UI.size.value = settings.size || 6;
  document.documentElement.style.setProperty('--clock-size', (settings.size||6) + 'rem');
  if(settings.pulse) startPulse(); else stopPulse();
  if(settings.rainbow) rainbowLoop(); else if(rainbowRAF){ cancelAnimationFrame(rainbowRAF); rainbowRAF=null }
  if(settings.cycle) startCycle(); else stopCycle();
  // wallpaper
  if(settings.wall) document.body.style.background = `url(${settings.wall}) center/cover fixed, linear-gradient(135deg,var(--accent),var(--soft))`;
  else applyTheme(currentTheme);
  // blur
  document.querySelector('#wrap').style.backdropFilter = settings.bgBlur ? 'blur(14px) saturate(1.05)' : 'blur(10px) saturate(1.05)';
  // particles initial sync (fixes default mismatch)
  syncParticleSettings();
}
applyAllSettingsToUI();

/* UI -> settings handlers (save to localStorage) */
UI.size.addEventListener('input', e=>{ settings.size = Number(e.target.value); document.documentElement.style.setProperty('--clock-size', e.target.value + 'rem'); saveAll(); });
UI.pulse.addEventListener('change', e=>{ settings.pulse = e.target.checked; e.target.checked ? startPulse() : stopPulse(); saveAll(); });
UI.rainbow.addEventListener('change', e=>{ settings.rainbow = e.target.checked; e.target.checked ? rainbowLoop() : (cancelAnimationFrame(rainbowRAF), rainbowRAF=null, applyTheme(currentTheme)); saveAll(); });
UI.cycle.addEventListener('change', e=>{ settings.cycle = e.target.checked; e.target.checked ? startCycle() : stopCycle(); saveAll(); });
UI.h24.addEventListener('change', e=>{ settings.h24 = e.target.checked; saveAll(); updateClock(); });
UI.applyWall.addEventListener('click', ()=>{ settings.wall = UI.wall.value.trim(); saveAll(); applyAllSettingsToUI(); });
UI.clearWall.addEventListener('click', ()=>{ settings.wall=''; UI.wall.value=''; saveAll(); applyAllSettingsToUI(); });

/* ---- Theme import/export/validate ---- */
function validateThemes(obj){
  if(!obj || typeof obj !== 'object') return {ok:false, msg:'Not an object'};
  for(const k of Object.keys(obj)){
    const v = obj[k];
    if(!Array.isArray(v) || v.length < 2) return {ok:false, msg:`"${k}" must be [strong, soft]`};
    if(typeof v[0] !== 'string' || typeof v[1] !== 'string') return {ok:false, msg:`"${k}" must use color strings`};
  }
  return {ok:true, msg:'OK'};
}
UI.exportThemes.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(themes, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'minifun-themes.json'; a.click(); URL.revokeObjectURL(a.href);
});
UI.downloadTemplate.addEventListener('click', ()=>{
  const tpl = { "example_theme": ["#123456","#abcdef"], "sunset": ["#ff7e5f","#feb47b"] };
  const blob = new Blob([JSON.stringify(tpl, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'theme-template.json'; a.click(); URL.revokeObjectURL(a.href);
});
UI.importFile.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const json = JSON.parse(txt);
    const res = validateThemes(json);
    UI.themeMsg.textContent = res.msg; UI.themeMsg.style.color = res.ok ? 'green' : 'crimson';
    if(res.ok){ themes = Object.assign({}, themes, json); buildThemeGrid(); saveAll(); }
  }catch(e){ UI.themeMsg.textContent='Invalid JSON'; UI.themeMsg.style.color='crimson'; }
});
UI.validateThemes.addEventListener('click', ()=>{ const res = validateThemes(themes); UI.themeMsg.textContent = res.msg; UI.themeMsg.style.color = res.ok ? 'green' : 'crimson'; });
UI.resetThemes.addEventListener('click', ()=>{ themes = structuredClone(DEFAULTS.themes); buildThemeGrid(); applyTheme(Object.keys(themes)[0]); saveAll(); UI.themeMsg.textContent='Reset to defaults'; UI.themeMsg.style.color='green'; });
UI.clearStorage.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_KEY); loadAll(); uiSyncFromSettings(); buildThemeGrid(); applyAllSettingsToUI(); UI.themeMsg.textContent='Cleared'; UI.themeMsg.style.color='crimson'; });

/* ---- Particle engine (optimized) ---- */
let particles = [];
let particlesEnabled = !!settings.particles;
let trails = !!settings.trails;
let fpsLimitOn = !!settings.fpsOn;
let fpsTarget = Math.max(10, Math.min(240, Number(settings.fpsVal || 60)));
let lastFrame = 0;
let spawnProb = 0.28;
let particleMax = 220;

function resizeCanvas(){
  const w = window.innerWidth || screen.width || 800;
  const h = window.innerHeight || screen.height || 600;
  if(canvas.width === w && canvas.height === h) return;
  canvas.width = w; canvas.height = h;
}
window.addEventListener('resize', resizeCanvas, {passive:true});
resizeCanvas();

function spawnParticle(){
  if(!particlesEnabled || particles.length > particleMax) return;
  const w = canvas.width, h = canvas.height;
  particles.push({
    x: Math.random()*w,
    y: h + 10,
    vx: (Math.random()-0.5)*0.6,
    vy: - (1 + Math.random()*2),
    size: 1 + Math.random()*3,
    life: 200 + Math.random()*200,
    maxLife: 200 + Math.random()*200,
    hue: Math.random()*360
  });
}

function clearParticles(){ particles = []; ctx.clearRect(0,0,canvas.width,canvas.height); }

function updateParticles(dt){
  if(!particlesEnabled) return;
  if(Math.random() < spawnProb) spawnParticle();
  const w = canvas.width, h = canvas.height;
  if(trails){
    ctx.fillStyle = 'rgba(255,255,255,0.03)'; // gentle fade for light theme
    ctx.fillRect(0,0,w,h);
  } else {
    ctx.clearRect(0,0,w,h);
  }
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx * (dt*0.06);
    p.y += p.vy * (dt*0.06);
    p.vy += 0.01 * (dt*0.06);
    p.life -= dt*0.06;
    const alpha = Math.max(0, Math.min(1, p.life / p.maxLife));
    ctx.beginPath();
    ctx.fillStyle = `hsla(${p.hue},70%,60%,${alpha*0.9})`;
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();
    if(p.life <= 0 || p.y > h + 50) particles.splice(i,1);
  }
}

/* FPS-limited RAF loop */
function rafLoop(ts){
  if(!lastFrame) lastFrame = ts;
  const dt = ts - lastFrame;
  if(!fpsLimitOn || dt >= (1000 / fpsTarget)){
    lastFrame = ts;
    updateParticles(dt);
  }
  requestAnimationFrame(rafLoop);
}
requestAnimationFrame(rafLoop);

/* sync particle settings (ensures UI state is the truth) */
function syncParticleSettings(){
  particlesEnabled = !!UI.particles.checked;
  trails = !!UI.trails.checked;
  fpsLimitOn = !!UI.fpsOn.checked;
  fpsTarget = Math.max(10, Math.min(240, Number(UI.fpsVal.value || 60)));
  // immediate effect: clear or spawn mini-flare
  if(!particlesEnabled) { clearParticles(); } else {
    for(let i=0;i<8;i++) spawnParticle(); // quick fill
  }
  settings.particles = particlesEnabled;
  settings.trails = trails;
  settings.fpsOn = fpsLimitOn;
  settings.fpsVal = fpsTarget;
  saveAll();
}
UI.particles.addEventListener('change', ()=>syncParticleSettings());
UI.trails.addEventListener('change', ()=>syncParticleSettings());
UI.fpsOn.addEventListener('change', ()=>syncParticleSettings());
UI.fpsVal.addEventListener('change', ()=>syncParticleSettings());
syncParticleSettings(); // initial sync - fixes default-on bug

/* ---- Glow trails: make particles draw additively if enabled (light tweak) ---- */
function setTrailsStyle(on){
  // variations can be implemented; currently trails flag toggles fade rectangle alpha above
  trails = !!on;
  syncParticleSettings();
}

/* ---- Background blur toggle ---- */
UI.bgBlur.addEventListener('change', e=>{
  settings.bgBlur = e.target.checked;
  document.querySelector('#wrap').style.backdropFilter = settings.bgBlur ? 'blur(14px) saturate(1.05)' : 'blur(10px) saturate(1.05)';
  saveAll();
});

/* ---- Neon toggle (palette) ---- */
UI.neon.addEventListener('change', e=>{
  settings.neon = e.target.checked;
  if(e.target.checked) document.body.classList.add('style-neon'); else document.body.classList.remove('style-neon');
  saveAll();
});

/* ---- Particle hotkey toggle ---- */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'KeyT'){ UI.particles.checked = !UI.particles.checked; syncParticleSettings(); }
  if(e.code === 'Space'){ // control stopwatch start/stop
    e.preventDefault();
    toggleStopwatch();
  }
});

/* =========================
   Stopwatch implementation
   ========================= */
let swRunning = false, swStartTime = 0, swElapsed = 0;
function updateSWDisplay(){
  const t = swElapsed + (swRunning ? (performance.now() - swStartTime) : 0);
  const cs = Math.floor((t/10)%100), s = Math.floor((t/1000)%60), m = Math.floor((t/60000)%60), h = Math.floor(t/3600000);
  const mm = String(m).padStart(2,'0'), ss = String(s).padStart(2,'0'), cs2 = String(cs).padStart(2,'0');
  UI.swDisplay.textContent = `${mm}:${ss}.${cs2}`;
  if(swRunning) requestAnimationFrame(updateSWDisplay);
}
UI.swStart.addEventListener('click', ()=>{
  if(swRunning) return;
  swRunning = true; swStartTime = performance.now(); requestAnimationFrame(updateSWDisplay);
});
UI.swStop.addEventListener('click', ()=>{ if(!swRunning) return; swRunning = false; swElapsed += performance.now() - swStartTime; });
UI.swReset.addEventListener('click', ()=>{ swRunning=false; swStartTime = 0; swElapsed = 0; UI.swDisplay.textContent='00:00.00'; });

function toggleStopwatch(){ if(swRunning) { UI.swStop.click(); } else { UI.swStart.click(); } }

/* =========================
   Timer implementation
   ========================= */
let timerRunning = false, timerRemaining = 0, timerLast = 0;
function parseTimeString(s){
  if(!s) return 0;
  const parts = s.split(':').map(x=>Number(x));
  if(parts.length === 1) return parts[0]*1000;
  if(parts.length === 2) return (parts[0]*60 + parts[1]) * 1000;
  if(parts.length === 3) return (parts[0]*3600 + parts[1]*60 + parts[2]) * 1000;
  return 0;
}
function formatTimer(ms){
  ms = Math.max(0, Math.floor(ms));
  const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function timerLoop(){
  if(!timerRunning) return;
  const now = performance.now();
  const dt = now - timerLast;
  timerLast = now;
  timerRemaining -= dt;
  UI.tDisplay.textContent = formatTimer(timerRemaining);
  if(timerRemaining <= 0){
    timerRunning = false; timerRemaining = 0; UI.tDisplay.textContent = '00:00:00';
    // beep
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      const ctxAudio = new AC();
      const o = ctxAudio.createOscillator(), g = ctxAudio.createGain();
      o.type = 'sine'; o.frequency.value = 880;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctxAudio.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.2, ctxAudio.currentTime + 0.02);
      setTimeout(()=>{ o.stop(); ctxAudio.close(); }, 500);
    }catch(e){}
    return;
  }
  requestAnimationFrame(timerLoop);
}
UI.tStart.addEventListener('click', ()=>{
  if(timerRunning) return;
  const ms = parseTimeString(UI.tInput.value.trim());
  if(ms <= 0) return;
  timerRemaining = ms; timerRunning = true; timerLast = performance.now(); requestAnimationFrame(timerLoop);
});
UI.tPause.addEventListener('click', ()=>{ timerRunning = false; });
UI.tReset.addEventListener('click', ()=>{ timerRunning = false; timerRemaining = 0; UI.tDisplay.textContent='00:00:00'; });

/* quick open of stopwatch/timer */
$('#quickSW').addEventListener('click', ()=>{
  $('#panel').style.display = 'block'; panel.setAttribute('aria-hidden','false');
  $$('.tab').forEach(t=>{ t.classList.toggle('active', t.dataset.tab === 'tools') });
  $$('.section').forEach(s=> s.classList.toggle('active', s.id === 'tools'));
  document.querySelector('#swStart').focus();
});
$('#quickTM').addEventListener('click', ()=>{
  $('#panel').style.display = 'block'; panel.setAttribute('aria-hidden','false');
  $$('.tab').forEach(t=>{ t.classList.toggle('active', t.dataset.tab === 'tools') });
  $$('.section').forEach(s=> s.classList.toggle('active', s.id === 'tools'));
  document.querySelector('#tInput').focus();
});

/* ---- Export / copy current theme as JSON snippet ---- */
function exportCurrentTheme(){
  const blob = new Blob([JSON.stringify(themes, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'minifun-themes.json'; a.click(); URL.revokeObjectURL(a.href);
}

/* ---- initial apply based on loaded settings ---- */
(function initFromSettings(){
  // apply UI toggles that affect behavior
  UI.pulse.checked = !!settings.pulse; UI.rainbow.checked = !!settings.rainbow; UI.cycle.checked = !!settings.cycle;
  UI.size.value = settings.size || 6; document.documentElement.style.setProperty('--clock-size', (settings.size||6) + 'rem');
  UI.h24.checked = !!settings.h24;
  UI.wall.value = settings.wall || '';
  UI.particles.checked = !!settings.particles;
  UI.fpsOn.checked = !!settings.fpsOn; UI.fpsVal.value = settings.fpsVal || 60;
  UI.trails.checked = !!settings.trails;
  UI.bgBlur.checked = !!settings.bgBlur;
  UI.neon.checked = !!settings.neon;

  // build theme grid and apply last theme
  buildThemeGrid();
  applyTheme(Object.keys(themes)[0]);
  applyAllSettingsToUI(); // apply size, pulse, rainbow, cycle, blur, particles initial
})();

/* helper used earlier (re-declared to ensure closure) */
function applyAllSettingsToUI(){
  document.documentElement.style.setProperty('--clock-size', (settings.size||6) + 'rem');
  if(settings.pulse) startPulse(); else stopPulse();
  if(settings.rainbow) rainbowLoop(); else { if(rainbowRAF) cancelAnimationFrame(rainbowRAF); rainbowRAF=null; }
  if(settings.cycle) startCycle(); else stopCycle();
  // wallpaper
  if(settings.wall) document.body.style.background = `url(${settings.wall}) center/cover fixed, linear-gradient(135deg,var(--accent),var(--soft))`;
  // blur
  document.querySelector('#wrap').style.backdropFilter = settings.bgBlur ? 'blur(14px) saturate(1.05)' : 'blur(10px) saturate(1.05)';
  // particle sync
  syncParticleSettings();
}

/* Save settings on change for simple inputs */
[['change','input']].forEach(()=>{}); // noop to avoid lint issues

/* save settings when page unloads */
window.addEventListener('beforeunload', ()=> saveAll());

/* small accessibility: focus first control on panel open */
$('#togglePanel').addEventListener('click', ()=> { $('#size').focus(); });

/* small debug interface exposure */
window.MiniFun = {
  themes, settings, applyTheme, exportCurrentTheme, spawnParticle: spawnParticle, clearParticles, syncParticleSettings
};

/* done! */
console.log('MiniFun Ultimate initialized — settings loaded.');
</script>
</body>
</html>